# Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø¯Ø§Ø®Øª - AI Startup Mentor

## ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

1. [Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª](#Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ-Ù¾Ø±Ø¯Ø§Ø®Øª)
2. [Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…](#Ù…Ø¹Ù…Ø§Ø±ÛŒ-Ø³ÛŒØ³ØªÙ…)
3. [Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù…](#Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ-Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù…)
4. [Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú©](#Ù…Ø¯ÛŒØ±ÛŒØª-Ø§Ø´ØªØ±Ø§Ú©)
5. [Ø§Ù…Ù†ÛŒØª](#Ø§Ù…Ù†ÛŒØª)
6. [ØªØ³Øª](#ØªØ³Øª)

---

## ğŸŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª

### 1ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÛŒØ±Ø§Ù†ÛŒ ğŸ‡®ğŸ‡·

#### Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ (ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡)

- **ÙˆØ¨â€ŒØ³Ø§ÛŒØª:** https://www.zarinpal.com
- **Ù…Ø³ØªÙ†Ø¯Ø§Øª:** https://www.zarinpal.com/docs/
- **Ú©Ø§Ø±Ù…Ø²Ø¯:** 1.5% - 2%
- **Ù…Ø²Ø§ÛŒØ§:**
  - Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ† Ø¯Ø±Ú¯Ø§Ù‡ Ø§ÛŒØ±Ø§Ù†
  - API Ø³Ø§Ø¯Ù‡ Ùˆ Ú©Ø§Ù…Ù„
  - Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø®ÙˆØ¨
  - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ

#### Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†:

- **Pay.ir** - Ú©Ø§Ø±Ù…Ø²Ø¯ Ú©Ù…ØªØ± (1.5%)
- **IDPay** - Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ù…Ø²Ø¯ ØªØ§ 500 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†
- **NextPay** - API Ù¾ÛŒØ´Ø±ÙØªÙ‡
- **Zibal** - Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø¹Ø§Ù„ÛŒ

### 2ï¸âƒ£ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ ğŸŒ

#### Stripe (ØªÙˆØµÛŒÙ‡ Ø§ÙˆÙ„)

- **ÙˆØ¨â€ŒØ³Ø§ÛŒØª:** https://stripe.com
- **Ù…Ø³ØªÙ†Ø¯Ø§Øª:** https://stripe.com/docs
- **Ú©Ø§Ø±Ù…Ø²Ø¯:** 2.9% + $0.30
- **Ù…Ø²Ø§ÛŒØ§:**
  - Ø¨Ù‡ØªØ±ÛŒÙ† API Ø¯Ø± Ø¯Ù†ÛŒØ§
  - Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú© built-in
  - Webhook Ù‚ÙˆÛŒ
  - Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ 135+ Ø§Ø±Ø²
- **Ù…Ø­Ø¯ÙˆØ¯ÛŒØª:** Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø´Ø±Ú©Øª Ø®Ø§Ø±Ø¬ÛŒ (Ø§ÛŒØ±Ø§Ù† Ø³Ø§Ù¾ÙˆØ±Øª Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯)

#### LemonSqueezy (ØªÙˆØµÛŒÙ‡ Ø¯ÙˆÙ…) ğŸ‹

- **ÙˆØ¨â€ŒØ³Ø§ÛŒØª:** https://lemonsqueezy.com
- **Ú©Ø§Ø±Ù…Ø²Ø¯:** 5% + $0.50
- **Ù…Ø²Ø§ÛŒØ§:**
  - Merchant of Record
  - Ù…Ø§Ù„ÛŒØ§Øª Ùˆ VAT Ø®ÙˆØ¯Ú©Ø§Ø±
  - Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø§Ø² Stripe
  - Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ú©Ù…ØªØ±

#### Paddle

- **ÙˆØ¨â€ŒØ³Ø§ÛŒØª:** https://paddle.com
- **Ú©Ø§Ø±Ù…Ø²Ø¯:** 5% + $0.50
- **Ù…Ø´Ø§Ø¨Ù‡ LemonSqueezy**

#### Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±ÛŒÙ¾ØªÙˆ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)

- **NOWPayments:** https://nowpayments.io
- **Coinbase Commerce:** https://commerce.coinbase.com
- **Ú©Ø§Ø±Ù…Ø²Ø¯:** 0.5% - 1%
- **Ù…Ø²Ø§ÛŒØ§:** Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ

---

## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…

### Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Supabase)

```sql
-- Ø¬Ø¯ÙˆÙ„ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  plan_id TEXT NOT NULL, -- 'free', 'starter', 'pro', 'enterprise'
  status TEXT NOT NULL, -- 'active', 'canceled', 'expired', 'trial'
  payment_provider TEXT, -- 'zarinpal', 'stripe', 'crypto', 'manual'

  -- ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
  started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE,
  canceled_at TIMESTAMP WITH TIME ZONE,

  -- Ù¾Ø±Ø¯Ø§Ø®Øª
  billing_cycle TEXT, -- 'monthly', 'yearly'
  amount DECIMAL(10, 2),
  currency TEXT DEFAULT 'USD', -- 'USD', 'IRR'

  -- Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
  stripe_subscription_id TEXT,
  stripe_customer_id TEXT,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ø¬Ø¯ÙˆÙ„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES subscriptions(id),

  -- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª
  amount DECIMAL(10, 2) NOT NULL,
  currency TEXT NOT NULL,
  payment_provider TEXT NOT NULL,
  payment_method TEXT, -- 'card', 'bank', 'crypto'

  -- ÙˆØ¶Ø¹ÛŒØª
  status TEXT NOT NULL, -- 'pending', 'completed', 'failed', 'refunded'

  -- Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
  provider_transaction_id TEXT,
  provider_payment_id TEXT,

  -- Ù…ØªØ§Ø¯ÛŒØªØ§
  metadata JSONB,
  description TEXT,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ø§ÛŒÙ†Ø¯Ú©Ø³â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_status ON transactions(status);
```

---

## ğŸš€ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø§Ù…â€ŒØ¨Ù‡â€ŒÚ¯Ø§Ù…

### Ù…Ø±Ø­Ù„Ù‡ 1: Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§

```bash
# Ø¨Ø±Ø§ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
npm install axios

# Ø¨Ø±Ø§ÛŒ Stripe (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
npm install @stripe/stripe-js @stripe/react-stripe-js
```

### Ù…Ø±Ø­Ù„Ù‡ 2: Ø³Ø§Ø®ØªØ§Ø± ÙÙˆÙ„Ø¯Ø±Ù‡Ø§

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”œâ”€â”€ zarinpal.ts      # Ø³Ø±ÙˆÛŒØ³ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
â”‚   â”‚   â”œâ”€â”€ stripe.ts         # Ø³Ø±ÙˆÛŒØ³ Stripe (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
â”‚   â”‚   â”œâ”€â”€ paymentService.ts # Ø³Ø±ÙˆÛŒØ³ Ø§ØµÙ„ÛŒ
â”‚   â”‚   â””â”€â”€ types.ts          # ØªØ§ÛŒÙ¾â€ŒÙ‡Ø§
â”‚   â””â”€â”€ subscription/
â”‚       â”œâ”€â”€ subscriptionService.ts
â”‚       â””â”€â”€ plans.ts
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”œâ”€â”€ CheckoutButton.tsx
â”‚   â”‚   â”œâ”€â”€ PaymentModal.tsx
â”‚   â”‚   â””â”€â”€ PaymentSuccess.tsx
â”‚   â””â”€â”€ subscription/
â”‚       â””â”€â”€ SubscriptionManager.tsx
â””â”€â”€ pages/
    â””â”€â”€ CheckoutPage.tsx
```

### Ù…Ø±Ø­Ù„Ù‡ 3: ØªØ§ÛŒÙ¾â€ŒÙ‡Ø§ÛŒ TypeScript

```typescript
// src/services/payment/types.ts

export type PaymentProvider = 'zarinpal' | 'stripe' | 'crypto' | 'manual';
export type Currency = 'USD' | 'IRR';
export type BillingCycle = 'monthly' | 'yearly';

export interface PaymentRequest {
  userId: string;
  planId: string;
  billingCycle: BillingCycle;
  amount: number;
  currency: Currency;
  callbackUrl: string;
}

export interface PaymentResult {
  success: boolean;
  transactionId?: string;
  paymentUrl?: string;
  error?: string;
}

export interface VerifyPaymentRequest {
  transactionId: string;
  authority?: string; // Ø¨Ø±Ø§ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
  paymentIntentId?: string; // Ø¨Ø±Ø§ÛŒ Stripe
}

export interface VerifyPaymentResult {
  success: boolean;
  refId?: string;
  cardPan?: string;
  error?: string;
}
```

### Ù…Ø±Ø­Ù„Ù‡ 4: Ø³Ø±ÙˆÛŒØ³ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„

```typescript
// src/services/payment/zarinpal.ts

import axios from 'axios';
import { PaymentRequest, PaymentResult, VerifyPaymentResult } from './types';

const ZARINPAL_MERCHANT_ID = import.meta.env.VITE_ZARINPAL_MERCHANT_ID;
const ZARINPAL_REQUEST_URL = 'https://api.zarinpal.com/pg/v4/payment/request.json';
const ZARINPAL_VERIFY_URL = 'https://api.zarinpal.com/pg/v4/payment/verify.json';
const ZARINPAL_PAYMENT_URL = 'https://www.zarinpal.com/pg/StartPay/';

export class ZarinpalService {
  /**
   * Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª
   */
  static async createPayment(request: PaymentRequest): Promise<PaymentResult> {
    try {
      // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù„Ø§Ø± Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† (Ø§Ú¯Ø± Ù„Ø§Ø²Ù…Ù‡)
      const amountInTomans =
        request.currency === 'USD'
          ? request.amount * 55000 // Ù†Ø±Ø® ØªÙ‚Ø±ÛŒØ¨ÛŒ - Ø¨Ø§ÛŒØ¯ Ø§Ø² API Ù†Ø±Ø® Ø§Ø±Ø² Ø¨Ú¯ÛŒØ±ÛŒØ¯
          : request.amount;

      const response = await axios.post(ZARINPAL_REQUEST_URL, {
        merchant_id: ZARINPAL_MERCHANT_ID,
        amount: amountInTomans * 10, // Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Ø¨Ù‡ Ø±ÛŒØ§Ù„ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡
        description: `Ø®Ø±ÛŒØ¯ Ù¾Ù„Ù† ${request.planId} - ${request.billingCycle}`,
        callback_url: request.callbackUrl,
        metadata: {
          email: '', // Ø§ÛŒÙ…ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
          mobile: '', // Ù…ÙˆØ¨Ø§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        },
      });

      const { data, errors } = response.data;

      if (errors && errors.length > 0) {
        return {
          success: false,
          error: errors[0].message,
        };
      }

      return {
        success: true,
        transactionId: data.authority,
        paymentUrl: `${ZARINPAL_PAYMENT_URL}${data.authority}`,
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª',
      };
    }
  }

  /**
   * ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
   */
  static async verifyPayment(
    authority: string,
    amountInTomans: number
  ): Promise<VerifyPaymentResult> {
    try {
      const response = await axios.post(ZARINPAL_VERIFY_URL, {
        merchant_id: ZARINPAL_MERCHANT_ID,
        amount: amountInTomans * 10, // Ø¨Ù‡ Ø±ÛŒØ§Ù„
        authority,
      });

      const { data, errors } = response.data;

      if (errors && errors.length > 0) {
        return {
          success: false,
          error: errors[0].message,
        };
      }

      return {
        success: true,
        refId: data.ref_id?.toString(),
        cardPan: data.card_pan,
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª',
      };
    }
  }
}
```

### Ù…Ø±Ø­Ù„Ù‡ 5: Ø³Ø±ÙˆÛŒØ³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú©

```typescript
// src/services/subscription/subscriptionService.ts

import { supabase } from '../../supabaseClient';
import { PaymentProvider, BillingCycle } from '../payment/types';

export interface CreateSubscriptionParams {
  userId: string;
  planId: string;
  billingCycle: BillingCycle;
  paymentProvider: PaymentProvider;
  amount: number;
  currency: string;
  transactionId: string;
}

export class SubscriptionService {
  /**
   * Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯
   */
  static async createSubscription(params: CreateSubscriptionParams) {
    const expiresAt = this.calculateExpiryDate(params.billingCycle);

    const { data, error } = await supabase
      .from('subscriptions')
      .insert({
        user_id: params.userId,
        plan_id: params.planId,
        status: 'active',
        payment_provider: params.paymentProvider,
        billing_cycle: params.billingCycle,
        amount: params.amount,
        currency: params.currency,
        started_at: new Date().toISOString(),
        expires_at: expiresAt,
      })
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  /**
   * Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
   */
  static async createTransaction(params: {
    userId: string;
    subscriptionId: string;
    amount: number;
    currency: string;
    paymentProvider: PaymentProvider;
    status: 'pending' | 'completed' | 'failed';
    providerTransactionId?: string;
  }) {
    const { data, error } = await supabase
      .from('transactions')
      .insert({
        user_id: params.userId,
        subscription_id: params.subscriptionId,
        amount: params.amount,
        currency: params.currency,
        payment_provider: params.paymentProvider,
        status: params.status,
        provider_transaction_id: params.providerTransactionId,
      })
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  /**
   * Ø¯Ø±ÛŒØ§ÙØª Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ú©Ø§Ø±Ø¨Ø±
   */
  static async getActiveSubscription(userId: string) {
    const { data, error } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('user_id', userId)
      .eq('status', 'active')
      .gte('expires_at', new Date().toISOString())
      .order('created_at', { ascending: false })
      .limit(1)
      .single();

    if (error && error.code !== 'PGRST116') throw error;
    return data;
  }

  /**
   * Ù„ØºÙˆ Ø§Ø´ØªØ±Ø§Ú©
   */
  static async cancelSubscription(subscriptionId: string) {
    const { data, error } = await supabase
      .from('subscriptions')
      .update({
        status: 'canceled',
        canceled_at: new Date().toISOString(),
      })
      .eq('id', subscriptionId)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  /**
   * Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§
   */
  private static calculateExpiryDate(billingCycle: BillingCycle): string {
    const now = new Date();
    if (billingCycle === 'monthly') {
      now.setMonth(now.getMonth() + 1);
    } else {
      now.setFullYear(now.getFullYear() + 1);
    }
    return now.toISOString();
  }

  /**
   * Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ (CRON Job)
   */
  static async checkExpiredSubscriptions() {
    const { data, error } = await supabase
      .from('subscriptions')
      .update({ status: 'expired' })
      .eq('status', 'active')
      .lt('expires_at', new Date().toISOString())
      .select();

    if (error) throw error;
    return data;
  }
}
```

### Ù…Ø±Ø­Ù„Ù‡ 6: Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Ø¯Ú©Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª

```typescript
// src/components/payment/CheckoutButton.tsx

import React, { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useLanguage } from '../../contexts/LanguageContext';
import { ZarinpalService } from '../../services/payment/zarinpal';
import { SubscriptionService } from '../../services/subscription/subscriptionService';

interface CheckoutButtonProps {
  planId: string;
  planName: string;
  price: number;
  billingCycle: 'monthly' | 'yearly';
  currency: 'USD' | 'IRR';
}

const CheckoutButton: React.FC<CheckoutButtonProps> = ({
  planId,
  planName,
  price,
  billingCycle,
  currency,
}) => {
  const { user } = useAuth();
  const { language } = useLanguage();
  const [loading, setLoading] = useState(false);

  const handleCheckout = async () => {
    if (!user) {
      alert(language === 'fa' ? 'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯' : 'Please sign in first');
      window.location.href = '/login';
      return;
    }

    setLoading(true);

    try {
      // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª
      const paymentResult = await ZarinpalService.createPayment({
        userId: user.id,
        planId,
        billingCycle,
        amount: price,
        currency,
        callbackUrl: `${window.location.origin}/payment/callback`,
      });

      if (!paymentResult.success) {
        throw new Error(paymentResult.error);
      }

      // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± localStorage Ø¨Ø±Ø§ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² callback
      localStorage.setItem(
        'pending_payment',
        JSON.stringify({
          userId: user.id,
          planId,
          billingCycle,
          amount: price,
          currency,
          transactionId: paymentResult.transactionId,
        })
      );

      // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª
      if (paymentResult.paymentUrl) {
        window.location.href = paymentResult.paymentUrl;
      }
    } catch (error: any) {
      alert(error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª');
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleCheckout}
      disabled={loading}
      className="w-full py-3 px-6 rounded-xl font-bold text-white bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 transition-all"
    >
      {loading
        ? language === 'fa'
          ? 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...'
          : 'Processing...'
        : language === 'fa'
          ? `Ø®Ø±ÛŒØ¯ ${planName}`
          : `Buy ${planName}`}
    </button>
  );
};

export default CheckoutButton;
```

### Ù…Ø±Ø­Ù„Ù‡ 7: ØµÙØ­Ù‡ Callback Ù¾Ø±Ø¯Ø§Ø®Øª

```typescript
// src/pages/PaymentCallbackPage.tsx

import React, { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useLanguage } from '../contexts/LanguageContext';
import { ZarinpalService } from '../services/payment/zarinpal';
import { SubscriptionService } from '../services/subscription/subscriptionService';

const PaymentCallbackPage: React.FC = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const { language } = useLanguage();
  const [status, setStatus] = useState<'processing' | 'success' | 'failed'>('processing');
  const [message, setMessage] = useState('');

  useEffect(() => {
    verifyPayment();
  }, []);

  const verifyPayment = async () => {
    try {
      // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² URL
      const authority = searchParams.get('Authority');
      const statusParam = searchParams.get('Status');

      if (statusParam !== 'OK' || !authority) {
        setStatus('failed');
        setMessage(language === 'fa' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù„ØºÙˆ Ø´Ø¯' : 'Payment canceled');
        return;
      }

      // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² localStorage
      const pendingPaymentStr = localStorage.getItem('pending_payment');
      if (!pendingPaymentStr) {
        throw new Error('Payment information not found');
      }

      const pendingPayment = JSON.parse(pendingPaymentStr);

      // ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
      const verifyResult = await ZarinpalService.verifyPayment(
        authority,
        pendingPayment.amount
      );

      if (!verifyResult.success) {
        throw new Error(verifyResult.error);
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
      const subscription = await SubscriptionService.createSubscription({
        userId: pendingPayment.userId,
        planId: pendingPayment.planId,
        billingCycle: pendingPayment.billingCycle,
        paymentProvider: 'zarinpal',
        amount: pendingPayment.amount,
        currency: pendingPayment.currency,
        transactionId: authority,
      });

      // Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
      await SubscriptionService.createTransaction({
        userId: pendingPayment.userId,
        subscriptionId: subscription.id,
        amount: pendingPayment.amount,
        currency: pendingPayment.currency,
        paymentProvider: 'zarinpal',
        status: 'completed',
        providerTransactionId: authority,
      });

      // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† localStorage
      localStorage.removeItem('pending_payment');

      setStatus('success');
      setMessage(
        language === 'fa'
          ? `Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚! Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: ${verifyResult.refId}`
          : `Payment successful! Reference ID: ${verifyResult.refId}`
      );

      // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
      setTimeout(() => {
        navigate('/entrepreneur');
      }, 3000);
    } catch (error: any) {
      setStatus('failed');
      setMessage(error.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
        {status === 'processing' && (
          <div className="text-center">
            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p className="text-xl font-semibold">
              {language === 'fa' ? 'Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª...' : 'Verifying payment...'}
            </p>
          </div>
        )}

        {status === 'success' && (
          <div className="text-center">
            <div className="text-6xl mb-4">âœ…</div>
            <h2 className="text-2xl font-bold text-green-600 mb-2">
              {language === 'fa' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚!' : 'Payment Successful!'}
            </h2>
            <p className="text-gray-600">{message}</p>
          </div>
        )}

        {status === 'failed' && (
          <div className="text-center">
            <div className="text-6xl mb-4">âŒ</div>
            <h2 className="text-2xl font-bold text-red-600 mb-2">
              {language === 'fa' ? 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚' : 'Payment Failed'}
            </h2>
            <p className="text-gray-600 mb-4">{message}</p>
            <button
              onClick={() => navigate('/pricing')}
              className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
            >
              {language === 'fa' ? 'Ø¨Ø§Ø²Ú¯Ø´Øª' : 'Go Back'}
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default PaymentCallbackPage;
```

---

## ğŸ” Ø§Ù…Ù†ÛŒØª

### 1. Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ (.env)

```bash
# Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
VITE_ZARINPAL_MERCHANT_ID=your-merchant-id

# Stripe (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
VITE_STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_... # ÙÙ‚Ø· Ø¯Ø± backend

# Supabase
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role # ÙÙ‚Ø· Ø¯Ø± backend
```

### 2. Edge Functions (Ø¨Ø±Ø§ÛŒ Webhooks)

```typescript
// supabase/functions/zarinpal-webhook/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  try {
    const { authority, status } = await req.json();

    // ØªØ§ÛŒÛŒØ¯ Ø§Ù…Ø¶Ø§ (Ø§Ú¯Ø± Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Ø³Ø§Ù¾ÙˆØ±Øª Ù…ÛŒâ€ŒÚ©Ù†Ù‡)

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ±Ø§Ú©
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // ... Ù„Ø§Ø¬ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø²Ø´

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
});
```

### 3. Row Level Security (RLS)

```sql
-- ÙÙ‚Ø· Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¨ØªÙˆÙ†Ù‡ Ø§Ø´ØªØ±Ø§Ú©Ø´ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù‡
CREATE POLICY "Users can view own subscriptions"
  ON subscriptions FOR SELECT
  USING (auth.uid() = user_id);

-- ÙÙ‚Ø· Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¨ØªÙˆÙ†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§Ø´ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù‡
CREATE POLICY "Users can view own transactions"
  ON transactions FOR SELECT
  USING (auth.uid() = user_id);
```

---

## ğŸ§ª ØªØ³Øª

### ØªØ³Øª Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡ (Sandbox)

Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ Sandbox Ø¯Ø§Ø±Ø¯:

- **URL:** https://sandbox.zarinpal.com
- **Merchant ID ØªØ³Øª:** Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø³ØªÙ†Ø¯Ø§Øª

### ØªØ³Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù†Ú©ÛŒ

Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¯Ø± Sandbox:

- Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: `5022-2910-XXXX-XXXX` (Ù‡Ø± 8 Ø±Ù‚Ù… Ø¯ÛŒÚ¯Ù‡)
- CVV2: Ù‡Ø± 3 ÛŒØ§ 4 Ø±Ù‚Ù…
- ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: Ù‡Ø± ØªØ§Ø±ÛŒØ®ÛŒ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡

---

## ğŸ“Š Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ

### Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡:

- ØªØ¹Ø¯Ø§Ø¯ Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
- Ø¯Ø±Ø¢Ù…Ø¯ Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡/Ø³Ø§Ù„ÛŒØ§Ù†Ù‡
- Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ (Conversion Rate)
- ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚

---

## ğŸš€ Ù…Ø±Ø§Ø­Ù„ Ø¨Ø¹Ø¯ÛŒ

### ÙØ§Ø² 1: MVP (Minimum Viable Product)

- [x] Ø·Ø±Ø§Ø­ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
- [ ] Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
- [ ] ØµÙØ­Ù‡ Checkout
- [ ] ØµÙØ­Ù‡ Callback
- [ ] ØªØ³Øª Ú©Ø§Ù…Ù„

### ÙØ§Ø² 2: Ø¨Ù‡Ø¨ÙˆØ¯

- [ ] Ø§ÙØ²ÙˆØ¯Ù† Stripe Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„
- [ ] Webhook Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±Ø³Ø§Ø²ÛŒ
- [ ] Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
- [ ] Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ†

### ÙØ§Ø² 3: Ù…Ù‚ÛŒØ§Ø³â€ŒÙ¾Ø°ÛŒØ±ÛŒ

- [ ] Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±ÛŒÙ¾ØªÙˆ
- [ ] ØªØ®ÙÛŒÙ Ùˆ Ú©ÙˆÙ¾Ù†
- [ ] Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ (Affiliate)
- [ ] ÙØ§Ú©ØªÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± (Invoice)

---

## ğŸ“š Ù…Ù†Ø§Ø¨Ø¹ Ù…ÙÛŒØ¯

### Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„

- Ù…Ø³ØªÙ†Ø¯Ø§Øª: https://www.zarinpal.com/docs/
- ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ: https://www.aparat.com/zarinpal
- Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: support@zarinpal.com

### Stripe

- Ù…Ø³ØªÙ†Ø¯Ø§Øª: https://stripe.com/docs
- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ React: https://stripe.com/docs/stripe-js/react

### Supabase

- Edge Functions: https://supabase.com/docs/guides/functions
- RLS: https://supabase.com/docs/guides/auth/row-level-security

---

## â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„

### 1. Ú©Ø¯ÙˆÙ… Ø¯Ø±Ú¯Ø§Ù‡ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ù…ØŸ

- **Ø§ÛŒØ±Ø§Ù†ÛŒ:** Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„ (Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†)
- **Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ:** Stripe (Ø¨Ù‡ØªØ±ÛŒÙ† API) ÛŒØ§ LemonSqueezy (Ø±Ø§Ø­Øªâ€ŒØªØ±)

### 2. Ú†Ø·ÙˆØ± Ù†Ø±Ø® Ø§Ø±Ø² Ø±Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†Ù…ØŸ

- Ø§Ø² API Ù†Ø±Ø® Ø§Ø±Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„ exchangerate-api.com)
- Ù†Ø±Ø® Ø±Ùˆ Ù‡Ø± 24 Ø³Ø§Ø¹Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†ÛŒØ¯
- ÛŒØ§ Ù†Ø±Ø® Ø«Ø§Ø¨Øª ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒØ¯

### 3. Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù‡ ÙˆÙ„ÛŒ Callback Ù†ÛŒØ§Ø¯ Ú†ÛŒØŸ

- Ø§Ø² Webhook Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
- ÛŒØ§ ÛŒÚ© CRON Job Ø¨Ø±Ø§ÛŒ Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ pending

### 4. Ú†Ø·ÙˆØ± ÙØ§Ú©ØªÙˆØ± ØµØ§Ø¯Ø± Ú©Ù†Ù…ØŸ

- Ø§Ø² jsPDF Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª PDF
- Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ± Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§ÛŒØ±Ø§Ù†ÛŒ
- Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±

### 5. Ø¢ÛŒØ§ Ø¨Ø§ÛŒØ¯ Ø´Ø±Ú©Øª Ø«Ø¨Øª Ú©Ù†Ù…ØŸ

- Ø¨Ø±Ø§ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„: Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§
- Ø¨Ø±Ø§ÛŒ Stripe: Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø´Ø±Ú©Øª Ø®Ø§Ø±Ø¬ÛŒ

---

## ğŸ’¡ Ù†Ú©Ø§Øª Ø·Ù„Ø§ÛŒÛŒ

1. **Ù‡Ù…ÛŒØ´Ù‡ ØªØ³Øª Ú©Ù†ÛŒØ¯:** Ù‚Ø¨Ù„ Ø§Ø² production Ø­ØªÙ…Ø§Ù‹ ØªØ³Øª Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯
2. **Log Ù‡Ù…Ù‡ Ú†ÛŒØ²:** ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø±Ùˆ Ù„Ø§Ú¯ Ú©Ù†ÛŒØ¯
3. **Webhook Ù…Ù‡Ù…Ù‡:** Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚
4. **Ø§Ù…Ù†ÛŒØª Ø§ÙˆÙ„:** Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª API Key Ø±Ùˆ commit Ù†Ú©Ù†ÛŒØ¯
5. **UX Ø®ÙˆØ¨:** ÙØ±Ø¢ÛŒÙ†Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø³Ø±ÛŒØ¹ Ùˆ Ø³Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ù‡
6. **Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:** Ø¨Ø±Ø§ÛŒ Ù…Ø´Ú©Ù„Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯

---

**Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ø¨Ø±Ø§ÛŒ AI Startup Mentor**
